
# First sanity checks (these catch a lot)

- Confirm FD limits for both processes (server and wrk), in the exact shell you start them:

```sh
ulimit -n
launchctl limit maxfiles
```

If wrk hits FD limits you’ll see timeouts / socket errors regardless of server speed.

# Check whether the kernel is dropping/queueing TCP work

## Loopback/interface drops

Look for input/output errors or drops increasing.

```sh
netstat -ibn | egrep 'Name|lo0'
ifconfig lo0
```

## TCP stack “bad events” (retransmits, drops, listen overflows)

```sh
hoaidv@MB25 waterlily % netstat -s -p tcp
tcp:
        0 packet sent
                0 data packet (0 byte)
                0 data packet (0 byte) retransmitted
                0 resend initiated by MTU discovery
                0 ack-only packet (0 delayed)
                0 URG only packet
                0 window probe packet
                0 window update packet
                0 control packet
                0 data packet sent after flow control
                0 challenge ACK sent due to unexpected SYN
                0 challenge ACK sent due to unexpected RST
                0 checksummed in software
                        0 segment (0 byte) over IPv4
                        0 segment (0 byte) over IPv6
        0 packet received
                0 ack (for 0 byte)
                0 duplicate ack
                0 ack for unsent data
                0 packet (0 byte) received in-sequence
                0 completely duplicate packet (0 byte)
                0 old duplicate packet
                0 received packet dropped due to low memory
                0 packet with some dup. data (0 byte duped)
                0 out-of-order packet (0 byte)
                0 packet (0 byte) of data after window
                0 window probe
                0 window update packet
                0 packet recovered after loss
                0 packet received after close
                0 bad reset
                0 discarded for bad checksum
                0 checksummed in software
                        0 segment (0 byte) over IPv4
                        0 segment (0 byte) over IPv6
                0 discarded for bad header offset field
                0 discarded because packet too short
        0 connection request
        0 connection accept
        0 bad connection attempt
        0 listen queue overflow
        0 connection established (including accepts)
        0 connection closed (including 0 drop)
                0 connection updated cached RTT on close
                0 connection updated cached RTT variance on close
                0 connection updated cached ssthresh on close
                0 connection initialized RTT from route cache
                0 connection initialized RTT variance from route cache
                0 connection initialized ssthresh from route cache
        0 embryonic connection dropped
        0 segment updated rtt (of 0 attempt)
        0 retransmit timeout
                0 connection dropped by rexmit timeout
                0 connection dropped after retransmitting FIN
                0 unnecessary packet retransmissions
        0 persist timeout
                0 connection dropped by persist timeout
        0 keepalive timeout
                0 keepalive probe sent
                0 connection dropped by keepalive
                0 connection dropped by keepalive offload
        0 correct ACK header prediction
        0 correct data packet header prediction
        0 SACK recovery episode
        0 segment rexmit in SACK recovery episodes
        0 byte rexmit in SACK recovery episodes
        0 SACK option (SACK blocks) received
        0 SACK option (SACK blocks) sent
        0 SACK scoreboard overflow
        0 segment retransmitted in RACK recovery episodes
        0 RACK recovery episode
        0 RACK recovery episode due to reordering timeout
        0 limited transmit done
        0 early retransmit done
        0 time cumulative ack advanced along with SACK
        0 probe timeout
                0 time retransmit timeout triggered after probe
                0 time probe packets were sent for an interface
                0 time couldn't send probe packets for an interface
                0 time fast recovery after tail loss
                0 time recovered last packet 
                0 SACK based rescue retransmit
        0 client connection attempted to negotiate ECN
                0 client connection successfully negotiated ECN
                0 time graceful fallback to Non-ECN connection
                0 time lost ECN negotiating SYN, followed by retransmission
                0 server connection attempted to negotiate ECN
                0 server connection successfully negotiated ECN
                0 time lost ECN negotiating SYN-ACK, followed by retransmission
                0 time received congestion experienced (CE) notification
                0 time CWR was sent in response to ECE
                0 time sent ECE notification
                0 connection received CE atleast once
                0 connection received ECE atleast once
                0 connection using ECN have seen packet loss but no CE
                0 connection using ECN have seen packet loss and CE
                0 connection using ECN received CE but no packet loss
                0 connection fell back to non-ECN due to SYN-loss
                0 connection fell back to non-ECN due to reordering
                0 connection fell back to non-ECN due to excessive CE-markings
                0 connection fell back caused by connection drop due to RST
                0 connection fell back due to drop after multiple retransmits 
                0 connection fell back due to RST after SYN
        0 time packet reordering was detected on a connection
                0 time transmitted packets were reordered
                0 time fast recovery was delayed to handle reordering
                0 time retransmission was avoided by delaying recovery
                0 retransmission not needed 
        0 retransmission due to tail loss
        0 time DSACK option was sent
                0 time DSACK option was received
                0 time DSACK was disabled on a connection
                0 time recovered from bad retransmission using DSACK
                0 time ignored DSACK due to ack loss
                0 time ignored old DSACK options
        0 time PMTU Blackhole detection, size reverted
        0 connection were dropped after long sleep
        0 connection had stretch ack algorithm disabled
        0 time a TFO-cookie has been announced
        0 SYN with data and a valid TFO-cookie have been received
        0 SYN with TFO-cookie-request received
        0 time an invalid TFO-cookie has been received
        0 time we requested a TFO-cookie
                0 time the peer announced a TFO-cookie
        0 time we combined SYN with data and a TFO-cookie
                0 time our SYN with data has been acknowledged
        0 time a connection-attempt with TFO fell back to regular TCP
        0 time a TFO-connection blackhole'd
        0 time a TFO-cookie we sent was wrong
        0 time did not received a TFO-cookie we asked for
        0 time TFO got disabled due to heuristicsn
        0 time TFO got blackholed in the sending direction
        0 time maximum segment size was changed to default
        0 time maximum segment size was changed to medium
        0 time maximum segment size was changed to low
        0 timer drift less or equal to 1 ms
        0 timer drift less or equal to 10 ms
        0 timer drift less or equal to 20 ms
        0 timer drift less or equal to 50 ms
        0 timer drift less or equal to 100 ms
        0 timer drift less or equal to 200 ms
        0 timer drift less or equal to 500 ms
        0 timer drift less or equal to 1000 ms
        0 timer drift greater than to 1000 ms
        0 FIN_WAIT timeout drop
        20368 open TCP sockets
```

### COMMENTS

No bad events observed.

----


## How many sockets are in TIME_WAIT / CLOSE_WAIT?

```sh
hoaidv@MB25 waterlily % netstat -anp tcp | awk '{print $6}' | sort | uniq -c | sort -nr | head
20352 ESTABLISHED
  20 LISTEN
   1 Foreign
   1 
```

### COMMENTS

That’s consistent with a 10k-connection localhost test (you see both directions / both endpoints).
No obvious “real network loss / backlog overflow” signals (at least in this snapshot):
- listen queue overflow is 0
- retransmits / drops are 0 in this output
So this does not look like packet loss.

----

## See backpressure directly: are sockets’ send/recv queues growing?

```sh
hoaidv@MB25 waterlily % netstat -anv -p tcp | egrep '\.8080|LISTEN|Proto' | head -n 50
Proto Recv-Q Send-Q  Local Address          Foreign Address        (state)        rxbytes    txbytes  rhiwat  shiwat    pid   epid state  options           gencnt    flags   flags1 usecnt rtncnt fltrs
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21966        ESTABLISHED     374736    6888994  513288  146988   3672      0 00102 00000004 00000000013c87f2 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21965        ESTABLISHED     386024    7184902  508580  131072   3672      0 00102 00000004 00000000013c87f1 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21964        ESTABLISHED     376260    6715969  512656  146988   3672      0 00102 00000004 00000000013c87f0 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21963        ESTABLISHED     370634    6850583  515001  146988   3672      0 00102 00000004 00000000013c87ef 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21962        ESTABLISHED     374362    6774336  513449  146988   3672      0 00102 00000004 00000000013c87ed 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.21966        127.0.0.1.8080         ESTABLISHED   13840284     156324  313418  131072  37262      0 00102 00000000 00000000013c87ee 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21961        ESTABLISHED     376582    6835723  512521  146988   3672      0 00102 00000004 00000000013c87ec 00000080 01000800      1      0 000000
tcp4    3600      0  127.0.0.1.21965        127.0.0.1.8080         ESTABLISHED   14434128     161032  282422  131072  37262      0 00102 00000000 00000000013c87eb 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21960        ESTABLISHED     371550    6902558  514621  146988   3672      0 00102 00000004 00000000013c87ea 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.21964        127.0.0.1.8080         ESTABLISHED   13494442     156956  486443  131072  37262      0 00102 00000000 00000000013c87e9 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21959        ESTABLISHED     373440    6763821  513832  146988   3672      0 00102 00000004 00000000013c87e8 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.21963        127.0.0.1.8080         ESTABLISHED   13762786     154611  351829  131072  37262      0 00102 00000000 00000000013c87e7 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.21962        127.0.0.1.8080         ESTABLISHED   13610812     156163  428076  131072  37262      0 00102 00000000 00000000013c87e6 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.21961        127.0.0.1.8080         ESTABLISHED   13733898     157091  366689  146988  37262      0 00102 00000000 00000000013c87e5 00000080 04000900      1      0 000000
tcp4    7987      0  127.0.0.1.21960        127.0.0.1.8080         ESTABLISHED   13867152     154991  307841  131072  37262      0 00102 00000000 00000000013c87e4 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.21959        127.0.0.1.8080         ESTABLISHED   13589730     155780  438591  131072  37262      0 00102 00000000 00000000013c87e3 00000080 04000900      1      0 000000
tcp4       0   7987  127.0.0.1.8080         127.0.0.1.21958        ESTABLISHED     372510    6712652  514219  146988   3672      0 00102 00000004 00000000013c87e2 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.21958        127.0.0.1.8080         ESTABLISHED   13471314     155393  497747  131072  37262      0 00102 00000000 00000000013c87e1 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21957        ESTABLISHED     373112    6723305  513970  146988   3672      0 00102 00000004 00000000013c87e0 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21956        ESTABLISHED     381920    6963663  510294  146988   3672      0 00102 00000004 00000000013c87df 00000080 01000800      1      0 000000
tcp4    7987      0  127.0.0.1.21957        127.0.0.1.8080         ESTABLISHED   13508802     155642  487094  146988  37262      0 00102 00000000 00000000013c87de 00000080 04000900      1      0 000000
tcp4    7987      0  127.0.0.1.21956        127.0.0.1.8080         ESTABLISHED   13990766     159318  508048  131072  37262      0 00102 00000000 00000000013c87dd 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21955        ESTABLISHED     373126    6643027  513963  146988   3672      0 00102 00000004 00000000013c87dc 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21954        ESTABLISHED     377216    7088579  512256  146988   3672      0 00102 00000004 00000000013c87db 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21953        ESTABLISHED     373762    6814350  513697  146988   3672      0 00102 00000004 00000000013c87da 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.21955        127.0.0.1.8080         ESTABLISHED   13347986     155649  298073  131072  37262      0 00102 00000000 00000000013c87d9 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21952        ESTABLISHED     377556    6875779  512112  146988   3672      0 00102 00000004 00000000013c87d8 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21951        ESTABLISHED     373422    6933663  513841  146988   3672      0 00102 00000004 00000000013c87d7 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21950        ESTABLISHED     378176    6839841  511854  146988   3672      0 00102 00000004 00000000013c87d6 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21949        ESTABLISHED     375668    6940380  512900  146988   3672      0 00102 00000004 00000000013c87d5 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21948        ESTABLISHED     372168    6660598  514364  146988   3672      0 00102 00000004 00000000013c87d4 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21947        ESTABLISHED     379456    7106730  511318  146988   3672      0 00102 00000004 00000000013c87d3 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21946        ESTABLISHED     374388    6948009  513436  146988   3672      0 00102 00000004 00000000013c87d2 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21945        ESTABLISHED     375968    6903259  512776  146988   3672      0 00102 00000004 00000000013c87d1 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.21954        127.0.0.1.8080         ESTABLISHED   14240026     157356  375145  131072  37262      0 00102 00000000 00000000013c87d0 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21944        ESTABLISHED     374722    6947372  513295  146988   3672      0 00102 00000004 00000000013c87cf 00000080 01000800      1      0 000000
tcp4    2713      0  127.0.0.1.21953        127.0.0.1.8080         ESTABLISHED   13690736     155915  390775  131072  37262      0 00102 00000000 00000000013c87ce 00000080 04000900      1      0 000000
tcp4    7987      0  127.0.0.1.21952        127.0.0.1.8080         ESTABLISHED   13814218     157500  334620  131072  37262      0 00102 00000000 00000000013c87cd 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.21951        127.0.0.1.8080         ESTABLISHED   13929466     155771  268749  146988  37262      0 00102 00000000 00000000013c87cc 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.21950        127.0.0.1.8080         ESTABLISHED   13742498     157758  362571  146988  37262      0 00102 00000000 00000000013c87cb 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.21949        127.0.0.1.8080         ESTABLISHED   13943056     156712  262032  131072  37262      0 00102 00000000 00000000013c87ca 00000080 04000900      1      0 000000
tcp4    1804      0  127.0.0.1.21948        127.0.0.1.8080         ESTABLISHED   13383128     155248  282306  131072  37262      0 00102 00000000 00000000013c87c9 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.21947        127.0.0.1.8080         ESTABLISHED   14276484     158294  356994  131072  37262      0 00102 00000000 00000000013c87c8 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.21946        127.0.0.1.8080         ESTABLISHED   13958366     156176  515715  131072  37262      0 00102 00000000 00000000013c87c7 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.21945        127.0.0.1.8080         ESTABLISHED   13868866     156836  299153  131072  37262      0 00102 00000000 00000000013c87c6 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.21944        127.0.0.1.8080         ESTABLISHED   13957040     156317  516352  131072  37262      0 00102 00000000 00000000013c87c5 00000080 04000900      1      0 000000
tcp4     131      0  127.0.0.1.8080         127.0.0.1.21943        ESTABLISHED     373770    6709110  513824  146988   3672      0 00102 00000004 00000000013c87c4 00000080 01000800      1      0 000000
tcp4       0    131  127.0.0.1.21943        127.0.0.1.8080         ESTABLISHED   13480256     155919  493302  131072  37262      0 00102 00000000 00000000013c87c3 00000080 04000900      1      0 000000
tcp4       0      0  127.0.0.1.8080         127.0.0.1.21942        ESTABLISHED     383826    6847338  509497  146988   3672      0 00102 00000004 00000000013c87c2 00000080 01000800      1      0 000000
tcp4       0      0  127.0.0.1.21942        127.0.0.1.8080         ESTABLISHED   13758480     160115  355074  131072  37262      0 00102 00000000 00000000013c87c1 00000080 04000900      1      0 000000
```

### COMMENTS 

TL;DR; The smoking gun: per-socket queueing / backpressure

In the netstat -anv snippet, many connections show non‑zero queue values like 3600, 7987, 2713, 1804 in the first columns:

Those non-zero values are exactly what you see when one side can’t keep up reading/writing, so data piles up in socket buffers. 
With wrk --timeout 3s, once buffers/queues build, a small fraction of requests will sit around long enough to hit ~seconds 
of end-to-end latency → wrk p99 ~2s and socket.timeout.

That also perfectly explains the mismatch:
- Server TP99 2–4ms: “handler/cache time”
- wrk TP99 ~1942ms: “time until response bytes are actually delivered to (and read by) the client”, 
  including waiting to flush when the client/kernel is slow.

# Conclusions

So is it “macOS network”?

It’s the macOS TCP/socket path under extreme localhost fanout, but the key symptom here 
is backpressure (send/recv queue buildup), not loss/retransmits.

The most common root cause in this exact situation is: the load generator (wrk + your Lua script) 
can’t drain sockets fast enough, which then slows the server’s writes and creates tail latency + timeouts.

----
